<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>official music fan club</title>
		<style>
			body { margin: 0; background-color: black; }
			canvas { display: block; }
            #ytplayer { pointer-events: none; }
            button {
                font-family: 'Courier New', monospace;
                background-color: black;
                color: white;
                font-size: 18px;
                outline: none;
                border-color: #ffffff;
                box-shadow: 0 0 5px #ffffff;
                transition: color 0.3s, background-color 0.3s;
            }
            button:hover {
                background-color: white;
                color: black;
                transition: color 0s, background-color 0s;
            }
            button:active {
                border-style: outset;
                background-color: black;
                color: white;
            }
		</style>
	</head>
	<body>
		<script type="module">
            import * as THREE from 'https://threejs.org/build/three.module.js';
            import { CSS3DRenderer, CSS3DObject } from 'https://threejs.org/examples/jsm/renderers/CSS3DRenderer.js';
            import { EffectComposer } from 'https://threejs.org/examples/jsm/postprocessing/EffectComposer.js';
            import { RenderPass } from 'https://threejs.org/examples/jsm/postprocessing/RenderPass.js';
            import { OutlinePass } from 'https://threejs.org/examples/jsm/postprocessing/OutlinePass.js';
            import { AfterimagePass } from 'https://threejs.org/examples/jsm/postprocessing/AfterimagePass.js';

            let plane;
            let CSSplane;
            let planeXRot = 0;
            let planeYRot = 0;
            let scene, CSSscene, camera, renderer, CSSrenderer, composer, ytplayer, ytEmbedObject;

            // constants
            const playlistID = 'UU1YTajqhUd01VO-yr5bL08A';
            const videoWidthPx = 480;
            const videoHeightPx = 360;
            const videoIDRegex = /[?&]v=([A-Za-z0-9_-]{11})/;

            window.addEventListener( 'resize', onWindowResize, false );
            window.addEventListener( 'mousemove', onMouseMove, false );

            function init() {

                scene = new THREE.Scene();
                CSSscene = new THREE.Scene();

                camera = new THREE.PerspectiveCamera( 120, window.innerWidth / window.innerHeight, 0.1, 1000 );
                camera.position.set(0, 0, 1);

                renderer = new THREE.WebGLRenderer({alpha: true});
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.domElement.style.position = 'absolute';
                renderer.domElement.style.zIndex = -2;
                renderer.domElement.style.top = 0;
                
                CSSrenderer = new CSS3DRenderer();
                CSSrenderer.domElement.style.position = 'absolute';
                CSSrenderer.domElement.style.top = 0;
                CSSrenderer.domElement.appendChild(renderer.domElement);

                document.body.appendChild(CSSrenderer.domElement);
                
                // build scene
                const material = new THREE.MeshBasicMaterial( {color: 0x000000, side: THREE.DoubleSide} );
                plane = new THREE.Mesh( new THREE.PlaneGeometry( 1, 1 ), material );
                scene.add( plane );
                
                // youtube embed
                const div = document.createElement( 'div' );
                div.style.width = `${videoWidthPx}px`;
                div.style.height = `${videoHeightPx}px`;
                div.style.backgroundColor = '#000';
                const iframe = document.createElement( 'iframe' );
                iframe.id = 'ytplayer';
                iframe.style.width = `${videoWidthPx}px`;
                iframe.style.height = `${videoHeightPx}px`;
                iframe.style.border = '0px';
                iframe.src = `https://www.youtube.com/embed/videoseries?list=${playlistID}&rel=0&controls=0&autoplay=1&enablejsapi=1&playsinline=1`;
                iframe.allow = 'accelerometer; autoplay; encrypted-media; gyroscope;';
                div.appendChild( iframe );
                ytEmbedObject = new CSS3DObject( div );
                ytEmbedObject.visible = false;

                // embed thumbnail (links to youtube page)
                const videoLink = document.createElement( 'a' );
                videoLink.id = 'videolink';
                const thumbnail = document.createElement( 'img' );
                thumbnail.id = 'thumbnail';
                thumbnail.style.width = `${videoWidthPx}px`;
                thumbnail.style.height = `${videoHeightPx}px`;
                videoLink.appendChild(thumbnail);
                ytEmbedObject.add(new CSS3DObject( videoLink ));

                // embed buttons
                const playButton = document.createElement( 'button' );
                playButton.style.width = `${videoWidthPx}px`;
                playButton.innerText = 'play';
                playButton.addEventListener('click', function (event) {
                    if (playButton.innerText === 'play') {
                        ytplayer.playVideo();
                    } else {
                        ytplayer.pauseVideo();
                    }
                });

                const playButtonObject = new CSS3DObject( playButton );
                ytEmbedObject.add( playButtonObject );
                playButtonObject.position.set(0, -videoHeightPx/2 - 20, 0);

                CSSplane = new THREE.Group();
                CSSplane.add( ytEmbedObject );

                window.onPlayerStateChange = function (event) {
                    if (event.data === YT.PlayerState.PLAYING) {
                        playButton.innerText = 'pause';
                        const url = ytplayer.getVideoUrl();
                        const link = document.getElementById('videolink');
                        const image = document.getElementById('thumbnail');
                        link.href = url;
                        link.target = '_blank';
                        const id = videoIDRegex.exec(url)[1];
                        console.log(id);
                        image.src = `https://img.youtube.com/vi/${id}/sddefault.jpg`
                    } else if (event.data === YT.PlayerState.PAUSED) {
                        playButton.innerText = 'play';
                    }
                }
                window.onYouTubeIframeAPIReady = function () {
                    ytplayer = new YT.Player('ytplayer', {
                        events: {
                            'onStateChange': onPlayerStateChange
                        }
                    });
                };

                CSSscene.add( CSSplane );

                // load iframe API
                const tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                const firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
                
                // postprocessing effects
                composer = new EffectComposer( renderer );
                composer.addPass( new RenderPass( scene, camera ) );
                const outlinePass = new OutlinePass(new THREE.Vector2(window.innerWidth, window.innerHeight), scene, camera, [plane]);
                outlinePass.edgeStrength = 8;
                outlinePass.visibleEdgeColor.set('#ffffff');
                composer.addPass( outlinePass );
                composer.addPass( new AfterimagePass() );
                
                onWindowResize();
            }

            function animate() {
                setTimeout(() => {
                    requestAnimationFrame(animate);
                }, 1000 / 60);
                if (plane != null) {
                    plane.rotation.x = (plane.rotation.x*5 + planeXRot) / 6;
                    plane.rotation.y = (plane.rotation.y*5 + planeYRot) / 6;
                }
                if (CSSplane != null) {
                    CSSplane.rotation.x = (CSSplane.rotation.x*5 + planeXRot) / 6;
                    CSSplane.rotation.y = (CSSplane.rotation.y*5 + planeYRot) / 6;
                }
                CSSrenderer.render(CSSscene, camera);
                composer.render(scene, camera);
            }

            function onWindowResize() {
                let width, height;
                if (window.visualViewport != undefined) {
                    width = window.visualViewport.width;
                    height = window.visualViewport.height;
                } else {
                    width = window.innerWidth;
                    height = window.innerHeight;
                }
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize( width, height );
                composer.setSize( width, height );
                CSSrenderer.setSize( width, height );
                // resize plane to fit in canvas
                if (plane != null) {
                    const vFOV = THREE.MathUtils.degToRad( camera.fov );
                    const visHeight = 2 * Math.tan( vFOV / 2 );
                    const visWidth = visHeight * camera.aspect;
                    plane.scale.set((width - 40) / width * visWidth, (height - 40) / height * visHeight, 1);
                }
                if (CSSrenderer != null) {
                    const vFOV = THREE.MathUtils.degToRad( camera.fov );
                    const visHeight = 2 * Math.tan( vFOV / 2 );
                    const visWidth = visHeight * camera.aspect;
                    let scale;
                    if (visHeight > visWidth) {
                        // fit to 1/3rd width
                        scale = visWidth / videoWidthPx / 3;
                    } else {
                        // fit to 1/3rd height
                        scale = visHeight / videoHeightPx / 3;
                    }
                    CSSscene.scale.set( scale, scale, scale );
                    // move yt embed to 3/4ths the way up the screen
                    if (ytEmbedObject != null) {
                        ytEmbedObject.position.set( 0, visHeight / scale / 4, 0 );
                    }
                }
            }

            function onMouseMove(event) {
                const size = new THREE.Vector2();
                renderer.getSize(size);
                const width = size.x;
                const height = size.y;
                planeYRot = (event.clientX - width/2) / width / 50;
                planeXRot = (event.clientY - height/2) / height / 50;
            }


            init();
            animate();
        </script>
	</body>
</html>